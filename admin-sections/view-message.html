<div class="message-details-container">
  <h2>üì® –î–µ—Ç–∞–π–ª–∏ –∑–∞ —Å—ä–æ–±—â–µ–Ω–∏–µ</h2>

  <div id="message-details">
    <p><strong>–ò–º–µ:</strong> <span id="msg-name">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</span></p>
    <p><strong>–ò–º–µ–π–ª:</strong> <span id="msg-email">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</span></p>
    <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> <span id="msg-phone">‚Äî</span></p>
    <p><strong>–¢–∏–ø:</strong> <span id="msg-type">‚Äî</span></p>
    <p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> <span id="msg-category">‚Äî</span></p>
    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="msg-status">‚Äî</span></p>
    <p><strong>–î–∞—Ç–∞:</strong> <span id="msg-date">‚Äî</span></p>
    <p><strong>–ê–¥—Ä–µ—Å –∑–∞ –¥–æ—Å—Ç–∞–≤–∫–∞:</strong> <span id="msg-address">‚Äî</span></p>
    <p><strong>–ù–∞—á–∏–Ω –Ω–∞ –ø–ª–∞—â–∞–Ω–µ:</strong> <span id="msg-payment">‚Äî</span></p>
    <p><strong>–ü–ª–∞—Ç–µ–Ω–æ:</strong> <span id="msg-paid">‚Äî</span></p>
    <p><strong>–°—ä–æ–±—â–µ–Ω–∏–µ:</strong></p>
    <p id="msg-content" style="white-space: pre-wrap; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px;"></p>

    <div id="msg-attachments">
      <strong>üìé –ü—Ä–∏–∫–∞—á–µ–Ω–∏ —Ñ–∞–π–ª–æ–≤–µ:</strong>
      <div id="msg-images" class="image-grid"></div>
    </div>
  </div>
</div>

<style>
.message-details-container {
  background: rgba(255, 255, 255, 0.05);
  padding: 20px;
  border-radius: 10px;
  max-width: 800px;
  margin: auto;
  color: #fce5cd;
}
.image-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
}
.image-grid img {
  width: 100px;
  height: auto;
  border-radius: 6px;
  cursor: pointer;
  transition: transform 0.2s;
}
.image-grid img:hover {
  transform: scale(1.1);
}
</style>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");

  if (!id) return alert("‚ùå –õ–∏–ø—Å–≤–∞ ID –Ω–∞ —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ");

  try {
    const response = await fetch(`https://api.dp-design.art/api/messages/${id}`);
    if (!response.ok) throw new Error("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ");

    const msg = await response.json();

    document.getElementById("msg-name").textContent = msg.name || "‚Äî";
    document.getElementById("msg-email").textContent = msg.email || "‚Äî";
    document.getElementById("msg-phone").textContent = msg.phone || "‚Äî";
    document.getElementById("msg-type").textContent = msg.type;
    document.getElementById("msg-status").textContent = msg.status || "‚Äî";
    document.getElementById("msg-date").textContent = new Date(msg.created_at).toLocaleString("bg-BG");
    document.getElementById("msg-category").textContent = msg.category || "‚Äî";
    document.getElementById("msg-address").textContent = msg.shipping_address || "‚Äî";
    document.getElementById("msg-payment").textContent = msg.payment_method || "‚Äî";
    document.getElementById("msg-paid").textContent = msg.is_paid ? "–î–∞" : "–ù–µ";
    document.getElementById("msg-content").textContent = msg.message || "‚Äî";

    const imageGrid = document.getElementById("msg-images");
    if (msg.attachments && msg.attachments.length > 0) {
      msg.attachments.forEach(file => {
        const img = document.createElement("img");
        img.src = `/uploads/${file}`;
        img.alt = "–ü—Ä–∏–∫–∞—á–µ–Ω —Ñ–∞–π–ª";
        img.addEventListener("click", () => {
          window.open(`/uploads/${file}`, "_blank");
        });
        imageGrid.appendChild(img);
      });
    } else {
      imageGrid.innerHTML = "‚ùå –ù—è–º–∞ –ø—Ä–∏–∫–∞—á–µ–Ω–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.";
    }

    // üîÅ –ú–∞—Ä–∫–∏—Ä–∞–º–µ –∫–∞—Ç–æ –ø—Ä–æ—á–µ—Ç–µ–Ω–æ
    if (!msg.is_read) {
      await fetch(`https://api.dp-design.art/api/messages/${id}/read`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" }
      });
    }

  } catch (err) {
    console.error("‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ:", err);
    alert("‚ùå –ù–µ—É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ.");
  }
});
</script>
