<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–•–≤–∞–Ω–∏ –∂–∏–≤–æ—Ç–∏–Ω–∫–∞—Ç–∞ üêæ</title>
  <style>
    :root { --bg:#8fd3ff; --text:#083c5a; }
    * { box-sizing: border-box; }
    html, body { height:100%; }
    body {
      margin:0; overflow:hidden; background:var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      touch-action: manipulation;
    }
    #hud {
      position: fixed; inset: 12px auto auto 12px;
      z-index: 3; color: var(--text); font-weight: 700;
      background: rgba(255,255,255,.6); padding: 8px 12px; border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,.15);
      user-select: none; display: flex; gap: 12px; align-items: center;
    }
    #score { font-size: 20px; }
    #soundBtn {
      border: 0; padding: 6px 10px; border-radius: 10px; cursor: pointer;
      background: #0ea5e9; color: #fff; font-weight: 700;
    }

    #startOverlay {
      position: fixed; inset: 0; z-index: 4; display: grid; place-items: center;
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.15));
      backdrop-filter: blur(3px);
    }
    #startCard {
      background: white; padding: 22px 24px; border-radius: 16px; text-align: center;
      width: min(92vw, 520px); box-shadow: 0 12px 30px rgba(0,0,0,.25); color:#123;
    }
    #startCard h1 { margin: 0 0 8px; font-size: 26px; }
    #startCard p { margin: 0 0 14px; }
    fieldset {
      border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px 14px; text-align: left;
      margin-bottom: 14px;
    }
    fieldset legend { padding: 0 6px; font-weight: 700; }
    .level {
      display: grid; grid-template-columns: 1.2em 1fr; align-items: start;
      gap: 10px; margin: 8px 0;
    }
    #startBtn {
      font-size: 20px; padding: 12px 18px; border-radius: 12px; border: 0;
      background: #16a34a; color: white; cursor: pointer; width: 100%;
    }
    #startBtn:active { transform: scale(.98); }

    .animal {
      position: absolute; width: clamp(72px, 8vw, 96px); height: clamp(72px, 8vw, 96px);
      display: grid; place-items: center; border-radius: 50%;
      background: rgba(255,255,255,.7); box-shadow: 0 6px 16px rgba(0,0,0,.2);
      user-select: none; -webkit-user-drag: none; touch-action: none;
      animation: floatUp linear forwards; cursor: pointer; z-index: 2;
    }
    .emoji { font-size: clamp(42px, 6vw, 56px); line-height: 1; transform: translateY(2px); }

    @keyframes floatUp {
      from { transform: translateY(105vh) rotate(0deg); opacity: .98; }
      to   { transform: translateY(-120px) rotate(6deg); opacity: 1; }
    }

    .pop {
      position: absolute; pointer-events: none; z-index: 5;
      font-size: 28px; animation: popfade 700ms ease-out forwards;
    }
    @keyframes popfade {
      0% { transform: translate(-50%,-50%) scale(.8); opacity: 1; }
      100% { transform: translate(-50%,-120%) scale(1.3); opacity: 0; }
    }
  </style>
</head>
<body>
  <div id="hud">
    <span id="score">–¢–æ—á–∫–∏: 0</span>
    <button id="soundBtn" aria-pressed="true" title="–í–∫–ª—é—á–∏/–∏–∑–∫–ª—é—á–∏ –∑–≤—É–∫">üîä –ó–≤—É–∫: –í–∫–ª.</button>
  </div>

  <div id="startOverlay" role="dialog" aria-modal="true">
    <div id="startCard">
      <h1>–•–≤–∞–Ω–∏ –∂–∏–≤–æ—Ç–∏–Ω–∫–∞—Ç–∞ üê∂üê±</h1>
      <p>–ö–ª–∏–∫/—Ç–∞–ø –∑–∞ –¥–∞ ‚Äû—Ö–≤–∞–Ω–µ—à‚Äú –∂–∏–≤–æ—Ç–∏–Ω–∫–∞—Ç–∞. –ò–∑–±–µ—Ä–∏ —Ç—Ä—É–¥–Ω–æ—Å—Ç –∏ –Ω–∞—Ç–∏—Å–Ω–∏ –°—Ç–∞—Ä—Ç.</p>

      <fieldset>
        <legend>–¢—Ä—É–¥–Ω–æ—Å—Ç</legend>

        <label class="level">
          <input type="radio" name="level" value="easy" checked />
          <div><strong>–õ–µ—Å–Ω–æ</strong> ‚Äî –±–∞–≤–Ω–∏ –∂–∏–≤–æ—Ç–∏–Ω–∫–∏, –ø–æ –µ–¥–Ω–∞ –Ω–∞ —Å—Ç—ä–ø–∫–∞.</div>
        </label>

        <label class="level">
          <input type="radio" name="level" value="medium" />
          <div><strong>–°—Ä–µ–¥–Ω–æ</strong> ‚Äî –ø–æ-–±—ä—Ä–∑–∏, –ø–æ–Ω—è–∫–æ–≥–∞ –ø–æ –¥–≤–µ –Ω–∞–≤–µ–¥–Ω—ä–∂.</div>
        </label>

        <label class="level">
          <input type="radio" name="level" value="hard" />
          <div><strong>–¢—Ä—É–¥–Ω–æ</strong> ‚Äî –±—ä—Ä–∑–∏, —á–µ—Å—Ç–æ –¥–≤–µ-—Ç—Ä–∏ –Ω–∞–≤–µ–¥–Ω—ä–∂.</div>
        </label>
      </fieldset>

      <button id="startBtn">–°—Ç–∞—Ä—Ç ‚ñ∂Ô∏è</button>
    </div>
  </div>

  <script>
    // ------- –°–™–°–¢–û–Ø–ù–ò–ï -------
    let score = 0;
    let spawnTimer = null;
    let audioCtx = null;
    let soundOn = true;

    const scoreEl = document.getElementById('score');
    const startOverlay = document.getElementById('startOverlay');
    const startBtn = document.getElementById('startBtn');
    const soundBtn = document.getElementById('soundBtn');

    const ANIMALS = ["üê∂","üê±","üêπ","üê∞","ü¶ä","üêª","üêº","üê®","üê∑","üêµ","üê∏","üê•","ü¶Ñ"];
    const COLORS = [
      "rgba(255,255,255,.85)",
      "rgba(255,245,210,.9)",
      "rgba(225,255,225,.9)",
      "rgba(225,240,255,.9)"
    ];

    // –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –ø–æ —Ç—Ä—É–¥–Ω–æ—Å—Ç
    const LEVELS = {
      easy:   { interval: 1100, speedMin: 5.5, speedMax: 8.0, perTick: () => 1 },
      medium: { interval: 850,  speedMin: 4.5, speedMax: 7.0, perTick: () => (Math.random() < 0.6 ? 2 : 1) },
      hard:   { interval: 650,  speedMin: 3.5, speedMax: 5.5, perTick: () => (Math.random() < 0.5 ? 2 : 3) }
    };

    function getSelectedLevelKey() {
      const sel = document.querySelector('input[name="level"]:checked');
      return sel ? sel.value : 'easy';
    }

    // ------- –ó–í–£–ö (WebAudio, –Ω–∞–¥–µ–∂–¥–µ–Ω —Å–ª–µ–¥ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–∏ –∂–µ—Å—Ç) -------
    function ensureAudio() {
      if (!audioCtx) {
        try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        catch { audioCtx = null; }
      }
    }

    function playPop() {
      if (!soundOn) return;
      ensureAudio();
      if (!audioCtx) return;

      // –ö—Ä–∞—Ç—ä–∫ ‚Äû–ø–æ–ø‚Äú: –≤–∏—Å–æ–∫ triangle + —â–∏–ø–∫–∞ noise –∑–∞ –ø–æ-–∏–≥—Ä–∏–≤ –µ—Ñ–µ–∫—Ç
      const now = audioCtx.currentTime;

      // –¢–æ–Ω–æ–≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(820, now);
      gain.gain.setValueAtTime(0.00001, now);
      gain.gain.exponentialRampToValueAtTime(0.25, now + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.00001, now + 0.09);
      osc.connect(gain).connect(audioCtx.destination);
      osc.start(now);
      osc.stop(now + 0.1);

      // –õ–µ–∫ noise ‚Äû–ø—É–∫‚Äú
      const bufferSize = 256;
      const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const data = noiseBuffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) data[i] = (Math.random() * 2 - 1) * (1 - i / bufferSize);
      const noise = audioCtx.createBufferSource();
      noise.buffer = noiseBuffer;
      const nGain = audioCtx.createGain();
      nGain.gain.setValueAtTime(0.00001, now);
      nGain.gain.exponentialRampToValueAtTime(0.15, now + 0.005);
      nGain.gain.exponentialRampToValueAtTime(0.00001, now + 0.07);
      noise.connect(nGain).connect(audioCtx.destination);
      noise.start(now);
      noise.stop(now + 0.08);
    }

    soundBtn.addEventListener('click', () => {
      soundOn = !soundOn;
      soundBtn.setAttribute('aria-pressed', soundOn ? 'true' : 'false');
      soundBtn.textContent = soundOn ? 'üîä –ó–≤—É–∫: –í–∫–ª.' : 'üîà –ó–≤—É–∫: –ò–∑–∫–ª.';
      // –†–∞–∑—Ä–µ—à–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –ø—ä—Ä–≤–æ –ø–∏–ø–∞–Ω–µ
      ensureAudio();
      if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
      // –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è
      if (soundOn) playPop();
    }, { passive: true });

    // ------- –ò–ì–†–ê -------
    function rand(min, max) { return Math.random() * (max - min) + min; }

    function spawnAnimal(levelCfg) {
      const d = document.createElement('div');
      d.className = 'animal';
      d.style.left = `${rand(0, Math.max(0, window.innerWidth - 100))}px`;
      d.style.background = COLORS[Math.floor(Math.random()*COLORS.length)];

      const dur = rand(levelCfg.speedMin, levelCfg.speedMax).toFixed(2);
      d.style.animationDuration = `${dur}s`;

      const span = document.createElement('span');
      span.className = 'emoji';
      span.textContent = ANIMALS[Math.floor(Math.random()*ANIMALS.length)];
      d.appendChild(span);

      // –ª–µ–∫–æ ‚Äû–Ω–∞–¥—É–≤–∞–Ω–µ‚Äú –ø—Ä–∏ –ø–æ—è–≤—è–≤–∞–Ω–µ –¥–æ–ª—É
      d.animate(
        [{transform:"translateY(105vh) scale(.9)"},{transform:"translateY(105vh) scale(1)"}],
        {duration:250, easing:"ease-out"}
      );

      d.addEventListener('pointerdown', (ev) => {
        catchAnimal(ev, d);
      }, { passive: true });

      document.body.appendChild(d);

      // –∞–≤—Ç–æ-–ø—Ä–µ–º–∞—Ö–≤–∞–Ω–µ —Å–ª–µ–¥ –∞–Ω–∏–º–∞—Ü–∏—è—Ç–∞
      const ttl = parseFloat(dur) * 1000 + 220;
      setTimeout(() => d.remove(), ttl);
    }

    function catchAnimal(ev, elem) {
      if (!elem.isConnected) return;
      score++;
      scoreEl.textContent = "–¢–æ—á–∫–∏: " + score;
      playPop();

      // pop –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
      const fx = document.createElement('div');
      fx.className = 'pop';
      fx.textContent = "+1";
      fx.style.left = (ev.clientX || (elem.getBoundingClientRect().left + elem.offsetWidth/2)) + "px";
      fx.style.top  = (ev.clientY || (elem.getBoundingClientRect().top + elem.offsetHeight/2)) + "px";
      document.body.appendChild(fx);
      setTimeout(() => fx.remove(), 800);

      elem.remove();
    }

    function startGame() {
      ensureAudio();
      if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();

      startOverlay.style.display = 'none';
      score = 0;
      scoreEl.textContent = "–¢–æ—á–∫–∏: 0";

      const levelKey = getSelectedLevelKey();
      const levelCfg = LEVELS[levelKey];

      // –ø—ä—Ä–≤–∏ —Å–ø–∞—É–Ω –≤–µ–¥–Ω–∞–≥–∞, –ø–æ—Å–ª–µ –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ
      tick(levelCfg);
      if (spawnTimer) clearInterval(spawnTimer);
      spawnTimer = setInterval(() => tick(levelCfg), levelCfg.interval);

      // –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–µ–ª–µ–≥–∏—Ä–∞–Ω–µ ‚Äî –∞–∫–æ –∫–ª–∏–∫—ä—Ç –µ –≤—ä—Ä—Ö—É –µ–º–æ–¥–∂–∏
      document.addEventListener('pointerdown', (ev) => {
        const target = ev.target.closest?.('.animal');
        if (target) catchAnimal(ev, target);
      }, { passive: true });
    }

    function tick(levelCfg) {
      const n = levelCfg.perTick();
      for (let i = 0; i < n; i++) spawnAnimal(levelCfg);
    }

    startBtn.addEventListener('click', startGame, { passive: true });

    // (–Ω–µ–∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ) ‚Äì –∞–∫–æ –∏—Å–∫–∞—à –¥–∞ –≤—ä—Ä–Ω–µ—à –∏–∑–±–æ—Ä–∞ –Ω–∞ –Ω–∏–≤–æ –±–µ–∑ —Ä–µ—Ñ—Ä–µ—à:
    // document.addEventListener('keydown', (e) => { if (e.key === 'Escape') location.reload(); });
  </script>
</body>
</html>
