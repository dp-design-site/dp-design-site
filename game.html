<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–•–≤–∞–Ω–∏ –∂–∏–≤–æ—Ç–∏–Ω–∫–∞—Ç–∞ üêæ</title>
  <style>
    :root { --bg:#8fd3ff; --text:#083c5a; }
    [hidden] { display: none !important; } /* –≤–∞–∂–Ω–æ: —Å–∫—Ä–∏–≤–∞ —Ñ–∏–Ω–∞–ª–Ω–∏—è –µ–∫—Ä–∞–Ω –≤ –Ω–∞—á–∞–ª–æ—Ç–æ */
    * { box-sizing: border-box; }
    html, body { height:100%; }
    body {
      margin:0; overflow:hidden; background:var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      touch-action: manipulation;
    }
    #hud {
      position: fixed; inset: 12px auto auto 12px;
      z-index: 3; color: var(--text); font-weight: 700;
      background: rgba(255,255,255,.6); padding: 8px 12px; border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,.15);
      user-select: none; display: flex; gap: 12px; align-items: center;
    }
    #score { font-size: 20px; }
    #timer { font-size: 18px; opacity: .9; }
    #soundBtn {
      border: 0; padding: 10px 14px; border-radius: 12px; cursor: pointer;
      background: #0ea5e9; color: #fff; font-weight: 700; font-size: 18px;
    }

    #startOverlay, #finalOverlay {
      position: fixed; inset: 0; z-index: 4; display: grid; place-items: center;
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.15));
      backdrop-filter: blur(3px);
      animation: fadeIn 0.4s ease;
    }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }

    .card {
      background: white; padding: 24px 26px; border-radius: 18px; text-align: center;
      width: min(92vw, 560px); box-shadow: 0 12px 30px rgba(0,0,0,.25); color:#123;
      animation: scaleIn 0.3s ease;
    }
    @keyframes scaleIn { from{transform:scale(.9);opacity:0} to{transform:scale(1);opacity:1} }
    .card h1 { margin: 0 0 8px; font-size: 26px; }
    .card p { margin: 0 0 14px; }

    fieldset {
      border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px 14px; text-align: left;
      margin-bottom: 14px;
    }
    fieldset legend { padding: 0 6px; font-weight: 700; }
    .row { display:grid; grid-template-columns: 1.2em 1fr; gap:10px; align-items:start; margin:8px 0; }

    .btn {
      font-size: 22px; padding: 16px 20px; border-radius: 14px; border: 0;
      background: #16a34a; color: white; cursor: pointer; width: 100%;
    }
    .btn:active { transform: scale(.97); }
    .btn.secondary { background:#0ea5e9; }

    .animal {
      position: absolute; width: clamp(72px, 8vw, 96px); height: clamp(72px, 8vw, 96px);
      display: grid; place-items: center; border-radius: 50%;
      background: rgba(255,255,255,.7); box-shadow: 0 6px 16px rgba(0,0,0,.2);
      user-select: none; -webkit-user-drag: none; touch-action: none;
      animation: floatUp linear forwards; cursor: pointer; z-index: 2;
    }
    .animal.big {
      width: clamp(110px, 12vw, 140px); height: clamp(110px, 12vw, 140px);
      border: 4px solid #f59e0b;
      background: rgba(255,250,210,.95);
    }
    .emoji { font-size: clamp(42px, 6vw, 56px); line-height: 1; transform: translateY(2px); }
    .animal.big .emoji { font-size: clamp(64px, 8vw, 84px); }

    @keyframes floatUp {
      from { transform: translateY(105vh) rotate(0deg); opacity: .98; }
      to   { transform: translateY(-120px) rotate(6deg); opacity: 1; }
    }

    .pop {
      position: absolute; pointer-events: none; z-index: 5;
      font-size: 32px; animation: popfade 700ms ease-out forwards;
    }
    @keyframes popfade {
      0% { transform: translate(-50%,-50%) scale(.8); opacity: 1; }
      100% { transform: translate(-50%,-120%) scale(1.3); opacity: 0; }
    }
  </style>
</head>
<body>
  <div id="hud">
    <span id="score">–¢–æ—á–∫–∏: 0</span>
    <span id="timer" hidden>‚è± 30.0s</span>
    <button id="soundBtn" aria-pressed="true" title="–í–∫–ª—é—á–∏/–∏–∑–∫–ª—é—á–∏ –∑–≤—É–∫">üîä –ó–≤—É–∫: –í–∫–ª.</button>
  </div>

  <!-- –°—Ç–∞—Ä—Ç–æ–≤ –µ–∫—Ä–∞–Ω -->
  <div id="startOverlay" role="dialog" aria-modal="true">
    <div class="card">
      <h1>–•–≤–∞–Ω–∏ –∂–∏–≤–æ—Ç–∏–Ω–∫–∞—Ç–∞ üê∂üê±</h1>
      <p>–ò–∑–±–µ—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –Ω–∞—Ç–∏—Å–Ω–∏ ‚Äû–°—Ç–∞—Ä—Ç‚Äú.</p>

      <fieldset>
        <legend>–¢—Ä—É–¥–Ω–æ—Å—Ç</legend>
        <label class="row"><input type="radio" name="level" value="easy" checked>
          <div><strong>–õ–µ—Å–Ω–æ</strong> ‚Äî –±–∞–≤–Ω–∏ –∂–∏–≤–æ—Ç–∏–Ω–∫–∏, –ø–æ –µ–¥–Ω–∞ –Ω–∞ —Å—Ç—ä–ø–∫–∞.</div></label>
        <label class="row"><input type="radio" name="level" value="medium">
          <div><strong>–°—Ä–µ–¥–Ω–æ</strong> ‚Äî –ø–æ-–±—ä—Ä–∑–∏, –ø–æ–Ω—è–∫–æ–≥–∞ –ø–æ –¥–≤–µ –Ω–∞–≤–µ–¥–Ω—ä–∂.</div></label>
        <label class="row"><input type="radio" name="level" value="hard">
          <div><strong>–¢—Ä—É–¥–Ω–æ</strong> ‚Äî –±—ä—Ä–∑–∏, —á–µ—Å—Ç–æ –¥–≤–µ-—Ç—Ä–∏ –Ω–∞–≤–µ–¥–Ω—ä–∂.</div></label>
      </fieldset>

      <fieldset>
        <legend>–†–µ–∂–∏–º</legend>
        <label class="row"><input type="radio" name="mode" value="timed" checked>
          <div><strong>30 —Å–µ–∫—É–Ω–¥–∏</strong> ‚Äî –∏–≥—Ä–∞–µ—à 30s, –ø–æ—Å–ª–µ —Ñ–∏–Ω–∞–ª–µ–Ω –µ–∫—Ä–∞–Ω.</div></label>
        <label class="row"><input type="radio" name="mode" value="endless">
          <div><strong>–ë–µ–∑–∫—Ä–∞–µ–Ω</strong> ‚Äî —Ç—Ä—É–¥–Ω–æ—Å—Ç—Ç–∞ —Ä–∞—Å—Ç–µ –Ω–∞ –≤—Å–µ–∫–∏ 20 —Ç–æ—á–∫–∏.</div></label>
      </fieldset>

      <fieldset>
        <legend>–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–æ</legend>
        <label class="row"><input type="checkbox" id="bigAnimal">
          <div><strong>–ì–æ–ª—è–º–æ –∂–∏–≤–æ—Ç–Ω–æ</strong> ‚Äî –Ω–∞ ~10s —Å–µ –ø–æ—è–≤—è–≤–∞ +5 —Ç.</div></label>
      </fieldset>

      <button id="startBtn" class="btn">–°—Ç–∞—Ä—Ç ‚ñ∂Ô∏è</button>
    </div>
  </div>

  <!-- –§–∏–Ω–∞–ª–µ–Ω –µ–∫—Ä–∞–Ω -->
  <div id="finalOverlay" hidden role="dialog" aria-modal="true">
    <div class="card">
      <h1>–ö—Ä–∞–π –Ω–∞ —Ä—É–Ω–¥–∞ üéâ</h1>
      <p id="finalScore">–¢–æ—á–∫–∏: 0</p>
      <div style="display:flex; gap:10px; margin-top:10px;">
        <button id="playAgain" class="btn secondary">–ò–≥—Ä–∞–π –ø–∞–∫</button>
        <button id="backToStart" class="btn">–ö—ä–º –Ω–∞—á–∞–ª–æ—Ç–æ</button>
      </div>
    </div>
  </div>

  <script>
    // --- –°–™–°–¢–û–Ø–ù–ò–ï ---
    let score = 0, spawnTimer=null, bigTimer=null, timerUIInterval=null;
    let audioCtx=null, soundOn=true, mode='timed', levelKey='easy';
    let curCfg=null, curInterval=null, roundEndTs=0;

    const scoreEl=document.getElementById('score');
    const timerEl=document.getElementById('timer');
    const startOverlay=document.getElementById('startOverlay');
    const finalOverlay=document.getElementById('finalOverlay');
    const soundBtn=document.getElementById('soundBtn');
    const bigAnimalChk=document.getElementById('bigAnimal');

    const ANIMALS=["üê∂","üê±","üêπ","üê∞","ü¶ä","üêª","üêº","üê®","üê∑","üêµ","üê∏","üê•","ü¶Ñ"];
    const BIG_ANIMALS=["ü¶Å","üêò","ü¶í","üê≥","ü¶à","ü¶ì"];
    const COLORS=["rgba(255,255,255,.85)","rgba(255,245,210,.9)","rgba(225,255,225,.9)","rgba(225,240,255,.9)"];

    const LEVELS={
      easy:{interval:1100,speedMin:5.5,speedMax:8.0,perTick:()=>1},
      medium:{interval:850,speedMin:4.5,speedMax:7.0,perTick:()=>Math.random()<0.6?2:1},
      hard:{interval:650,speedMin:3.5,speedMax:5.5,perTick:()=>Math.random()<0.5?2:3}
    };

    function getSelected(name){const el=document.querySelector(`input[name="${name}"]:checked`);return el?el.value:null;}
    function rand(min,max){return Math.random()*(max-min)+min;}

    // --- –ó–í–£–ö ---
    function ensureAudio(){if(!audioCtx){try{audioCtx=new (window.AudioContext||window.webkitAudioContext)();}catch{audioCtx=null;}}}
    function playPop(mult=1){if(!soundOn)return;ensureAudio();if(!audioCtx)return;const now=audioCtx.currentTime;
      const osc=audioCtx.createOscillator(),gain=audioCtx.createGain();
      osc.type='triangle';osc.frequency.setValueAtTime(mult>1?620:820,now);
      gain.gain.setValueAtTime(0.00001,now);
      gain.gain.exponentialRampToValueAtTime(0.25*Math.min(mult,1.6),now+0.01);
      gain.gain.exponentialRampToValueAtTime(0.00001,now+0.11);
      osc.connect(gain).connect(audioCtx.destination);osc.start(now);osc.stop(now+0.12);
      const buf=audioCtx.createBuffer(1,256,audioCtx.sampleRate),data=buf.getChannelData(0);
      for(let i=0;i<256;i++)data[i]=(Math.random()*2-1)*(1-i/256);
      const noise=audioCtx.createBufferSource();noise.buffer=buf;
      const nGain=audioCtx.createGain();nGain.gain.setValueAtTime(0.00001,now);
      nGain.gain.exponentialRampToValueAtTime(0.18*Math.min(mult,1.6),now+0.005);
      nGain.gain.exponentialRampToValueAtTime(0.00001,now+0.08);
      noise.connect(nGain).connect(audioCtx.destination);noise.start(now);noise.stop(now+0.09);
    }
    soundBtn.onclick=()=>{soundOn=!soundOn;soundBtn.textContent=soundOn?'üîä –ó–≤—É–∫: –í–∫–ª.':'üîà –ó–≤—É–∫: –ò–∑–∫–ª.';ensureAudio();if(audioCtx&&audioCtx.state==='suspended')audioCtx.resume();if(soundOn)playPop();};

    // --- –ñ–ò–í–û–¢–ù–ò ---
    function makeAnimal(isBig,cfg){
      const d=document.createElement('div');d.className=isBig?'animal big':'animal';
      d.style.left=`${rand(0,Math.max(0,window.innerWidth-(isBig?140:100)))}px`;
      d.style.background=COLORS[Math.floor(Math.random()*COLORS.length)];
      const dur=rand(cfg.speedMin,cfg.speedMax).toFixed(2);d.style.animationDuration=`${dur}s`;
      const span=document.createElement('span');span.className='emoji';
      span.textContent=isBig?BIG_ANIMALS[Math.floor(Math.random()*BIG_ANIMALS.length)]:ANIMALS[Math.floor(Math.random()*ANIMALS.length)];
      d.appendChild(span);
      d.addEventListener('pointerdown',ev=>catchAnimal(ev,d,isBig?5:1),{passive:true});
      document.body.appendChild(d);setTimeout(()=>d.remove(),parseFloat(dur)*1000+220);
    }
    function popFx(x,y,text){const fx=document.createElement('div');fx.className='pop';fx.textContent=text;fx.style.left=x+"px";fx.style.top=y+"px";document.body.appendChild(fx);setTimeout(()=>fx.remove(),800);}
    function catchAnimal(ev,elem,pts){if(!elem.isConnected)return;score+=pts;scoreEl.textContent="–¢–æ—á–∫–∏: "+score;playPop(pts>1?1.4:1);
      const r=elem.getBoundingClientRect();const x=ev.clientX||(r.left+r.width/2),y=ev.clientY||(r.top+r.height/2);popFx(x,y,pts>1?`+${pts}`:"+1");
      elem.remove();if(mode==='endless')maybeAdjustDifficulty();}
    function selectedLevelCfg(){return {...LEVELS[levelKey]};}

    // --- –ë–µ–∑–∫—Ä–∞–µ–Ω —Ä–µ–∂–∏–º, –ø–æ–≤–∏—à–∞–≤–∞–Ω–µ –Ω–∞ —Ç—Ä—É–¥–Ω–æ—Å—Ç ---
    function maybeAdjustDifficulty(){const steps=Math.floor(score/20);const base=LEVELS[levelKey];const minInt=420,speedBoost=Math.min(steps*0.3,1.6);
      const newCfg={interval:Math.max(base.interval-steps*80,minInt),speedMin:Math.max(base.speedMin-speedBoost,2.6),speedMax:Math.max(base.speedMax-speedBoost,base.speedMin),perTick:base.perTick};curCfg=newCfg;
      if(curInterval!==newCfg.interval&&spawnTimer){clearInterval(spawnTimer);curInterval=newCfg.interval;spawnTimer=setInterval(()=>tick(newCfg),newCfg.interval);}}
    function tick(cfg){const n=cfg.perTick();for(let i=0;i<n;i++)makeAnimal(false,cfg);}
    function startBigLoop(en){if(bigTimer){clearInterval(bigTimer);bigTimer=null;}if(!en)return;setTimeout(()=>makeAnimal(true,curCfg||selectedLevelCfg()),rand(6000,12000));bigTimer=setInterval(()=>makeAnimal(true,curCfg||selectedLevelCfg()),10000);}
    function clearAnimals(){document.querySelectorAll('.animal').forEach(n=>n.remove());}

    // --- –°—Ç–∞—Ä—Ç / –ö—Ä–∞–π ---
    function startGame(){levelKey=getSelected('level')||'easy';mode=getSelected('mode')||'timed';const bigEn=bigAnimalChk.checked;
      ensureAudio();if(audioCtx&&audioCtx.state==='suspended')audioCtx.resume();
      startOverlay.hidden=true;finalOverlay.hidden=true;timerEl.hidden=(mode!=='timed');score=0;scoreEl.textContent="–¢–æ—á–∫–∏: 0";
      curCfg=selectedLevelCfg();curInterval=curCfg.interval;
      tick(curCfg);if(spawnTimer)clearInterval(spawnTimer);spawnTimer=setInterval(()=>tick(curCfg),curCfg.interval);
      startBigLoop(bigEn);
      if(mode==='timed')startTimedRound(30);else if(timerUIInterval){clearInterval(timerUIInterval);timerUIInterval=null;}
      document.addEventListener('pointerdown',docPointer,{passive:true});}
    function docPointer(ev){const t=ev.target.closest?.('.animal');if(t)catchAnimal(ev,t,t.classList.contains('big')?5:1);}
    function endGame(){if(spawnTimer)clearInterval(spawnTimer);if(bigTimer)clearInterval(bigTimer);if(timerUIInterval)clearInterval(timerUIInterval);
      spawnTimer=bigTimer=timerUIInterval=null;document.removeEventListener('pointerdown',docPointer);clearAnimals();}
    function startTimedRound(sec){const startTs=performance.now();roundEndTs=startTs+sec*1000;
      const fmt=ms=>(ms/1000).toFixed(1)+"s";timerEl.textContent="‚è± "+fmt(sec*1000);
      timerUIInterval=setInterval(()=>{const now=performance.now();const left=Math.max(0,roundEndTs-now);
        timerEl.textContent="‚è± "+fmt(left);if(left<=0){clearInterval(timerUIInterval);timerUIInterval=null;endGame();
          document.getElementById('finalScore').textContent="–¢–æ—á–∫–∏: "+score;finalOverlay.hidden=false;}},100);}

    // --- –ë—É—Ç–æ–Ω–∏ ---
    document.getElementById('startBtn').onclick=startGame;
    document.getElementById('playAgain').onclick=()=>{finalOverlay.hidden=true;startGame();};
    document.getElementById('backToStart').onclick=()=>{finalOverlay.hidden=true;startOverlay.hidden=false;};
  </script>
</body>
</html>
