<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–•–≤–∞–Ω–∏ –∂–∏–≤–æ—Ç–∏–Ω–∫–∞—Ç–∞ üêæ</title>
  <style>
    :root { --bg:#8fd3ff; --text:#083c5a; }
    * { box-sizing: border-box; }
    html, body { height:100%; }
    body {
      margin:0; overflow:hidden; background:var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      touch-action: manipulation;
    }
    #hud {
      position: fixed; inset: 12px auto auto 12px;
      z-index: 3; color: var(--text); font-weight: 700;
      background: rgba(255,255,255,.6); padding: 8px 12px; border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,.15);
      user-select: none; display: flex; gap: 12px; align-items: center;
    }
    #score { font-size: 20px; }
    #timer { font-size: 18px; opacity: .9; }
    #soundBtn {
      border: 0; padding: 6px 10px; border-radius: 10px; cursor: pointer;
      background: #0ea5e9; color: #fff; font-weight: 700;
    }

    #startOverlay, #finalOverlay {
      position: fixed; inset: 0; z-index: 4; display: grid; place-items: center;
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.15));
      backdrop-filter: blur(3px);
    }
    .card {
      background: white; padding: 22px 24px; border-radius: 16px; text-align: center;
      width: min(92vw, 560px); box-shadow: 0 12px 30px rgba(0,0,0,.25); color:#123;
    }
    .card h1 { margin: 0 0 8px; font-size: 26px; }
    .card p { margin: 0 0 14px; }

    fieldset {
      border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px 14px; text-align: left;
      margin-bottom: 14px;
    }
    fieldset legend { padding: 0 6px; font-weight: 700; }
    .row { display:grid; grid-template-columns: 1.2em 1fr; gap:10px; align-items:start; margin:8px 0; }

    .btn {
      font-size: 20px; padding: 12px 18px; border-radius: 12px; border: 0;
      background: #16a34a; color: white; cursor: pointer; width: 100%;
    }
    .btn:active { transform: scale(.98); }
    .btn.secondary { background:#0ea5e9; }

    .animal {
      position: absolute; width: clamp(72px, 8vw, 96px); height: clamp(72px, 8vw, 96px);
      display: grid; place-items: center; border-radius: 50%;
      background: rgba(255,255,255,.7); box-shadow: 0 6px 16px rgba(0,0,0,.2);
      user-select: none; -webkit-user-drag: none; touch-action: none;
      animation: floatUp linear forwards; cursor: pointer; z-index: 2;
    }
    .animal.big {
      width: clamp(110px, 12vw, 140px); height: clamp(110px, 12vw, 140px);
      border: 4px solid #f59e0b; /* –∑–ª–∞—Ç–µ–Ω —Ä–∏–Ω–≥ */
      background: rgba(255,250,210,.95);
    }
    .emoji { font-size: clamp(42px, 6vw, 56px); line-height: 1; transform: translateY(2px); }
    .animal.big .emoji { font-size: clamp(64px, 8vw, 84px); }

    @keyframes floatUp {
      from { transform: translateY(105vh) rotate(0deg); opacity: .98; }
      to   { transform: translateY(-120px) rotate(6deg); opacity: 1; }
    }

    .pop {
      position: absolute; pointer-events: none; z-index: 5;
      font-size: 28px; animation: popfade 700ms ease-out forwards;
    }
    @keyframes popfade {
      0% { transform: translate(-50%,-50%) scale(.8); opacity: 1; }
      100% { transform: translate(-50%,-120%) scale(1.3); opacity: 0; }
    }
  </style>
</head>
<body>
  <div id="hud">
    <span id="score">–¢–æ—á–∫–∏: 0</span>
    <span id="timer" hidden>‚è± 30.0s</span>
    <button id="soundBtn" aria-pressed="true" title="–í–∫–ª—é—á–∏/–∏–∑–∫–ª—é—á–∏ –∑–≤—É–∫">üîä –ó–≤—É–∫: –í–∫–ª.</button>
  </div>

  <!-- –°—Ç–∞—Ä—Ç–æ–≤ –µ–∫—Ä–∞–Ω -->
  <div id="startOverlay" role="dialog" aria-modal="true">
    <div class="card">
      <h1>–•–≤–∞–Ω–∏ –∂–∏–≤–æ—Ç–∏–Ω–∫–∞—Ç–∞ üê∂üê±</h1>
      <p>–ò–∑–±–µ—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –Ω–∞—Ç–∏—Å–Ω–∏ ‚Äû–°—Ç–∞—Ä—Ç‚Äú.</p>

      <fieldset>
        <legend>–¢—Ä—É–¥–Ω–æ—Å—Ç</legend>
        <label class="row"><input type="radio" name="level" value="easy" checked>
          <div><strong>–õ–µ—Å–Ω–æ</strong> ‚Äî –±–∞–≤–Ω–∏ –∂–∏–≤–æ—Ç–∏–Ω–∫–∏, –ø–æ –µ–¥–Ω–∞ –Ω–∞ —Å—Ç—ä–ø–∫–∞.</div></label>
        <label class="row"><input type="radio" name="level" value="medium">
          <div><strong>–°—Ä–µ–¥–Ω–æ</strong> ‚Äî –ø–æ-–±—ä—Ä–∑–∏, –ø–æ–Ω—è–∫–æ–≥–∞ –ø–æ –¥–≤–µ –Ω–∞–≤–µ–¥–Ω—ä–∂.</div></label>
        <label class="row"><input type="radio" name="level" value="hard">
          <div><strong>–¢—Ä—É–¥–Ω–æ</strong> ‚Äî –±—ä—Ä–∑–∏, —á–µ—Å—Ç–æ –¥–≤–µ-—Ç—Ä–∏ –Ω–∞–≤–µ–¥–Ω—ä–∂.</div></label>
      </fieldset>

      <fieldset>
        <legend>–†–µ–∂–∏–º</legend>
        <label class="row"><input type="radio" name="mode" value="timed" checked>
          <div><strong>30 —Å–µ–∫—É–Ω–¥–∏</strong> ‚Äî –∏–≥—Ä–∞–µ—à 30s, –ø–æ—Å–ª–µ —Ñ–∏–Ω–∞–ª–µ–Ω –µ–∫—Ä–∞–Ω.</div></label>
        <label class="row"><input type="radio" name="mode" value="endless">
          <div><strong>–ë–µ–∑–∫—Ä–∞–µ–Ω</strong> ‚Äî —Ç—Ä—É–¥–Ω–æ—Å—Ç—Ç–∞ —Ä–∞—Å—Ç–µ –Ω–∞ –≤—Å–µ–∫–∏ 20 —Ç–æ—á–∫–∏.</div></label>
      </fieldset>

      <fieldset>
        <legend>–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–æ</legend>
        <label class="row"><input type="checkbox" id="bigAnimal">
          <div><strong>–ì–æ–ª—è–º–æ –∂–∏–≤–æ—Ç–Ω–æ</strong> ‚Äî –Ω–∞ ~10s —Å–µ –ø–æ—è–≤—è–≤–∞ +5 —Ç.</div></label>
      </fieldset>

      <button id="startBtn" class="btn">–°—Ç–∞—Ä—Ç ‚ñ∂Ô∏è</button>
    </div>
  </div>

  <!-- –§–∏–Ω–∞–ª–µ–Ω –µ–∫—Ä–∞–Ω (–∑–∞ 30s —Ä–µ–∂–∏–º) -->
  <div id="finalOverlay" hidden role="dialog" aria-modal="true">
    <div class="card">
      <h1>–ö—Ä–∞–π –Ω–∞ —Ä—É–Ω–¥–∞ üéâ</h1>
      <p id="finalScore">–¢–æ—á–∫–∏: 0</p>
      <div style="display:flex; gap:10px; margin-top:10px;">
        <button id="playAgain" class="btn secondary">–ò–≥—Ä–∞–π –ø–∞–∫</button>
        <button id="backToStart" class="btn">–ö—ä–º –Ω–∞—á–∞–ª–æ—Ç–æ</button>
      </div>
    </div>
  </div>

  <script>
    // ------- –°–™–°–¢–û–Ø–ù–ò–ï -------
    let score = 0;
    let spawnTimer = null;
    let bigTimer = null;
    let audioCtx = null;
    let soundOn = true;
    let mode = 'timed'; // 'timed' | 'endless'
    let levelKey = 'easy';
    let roundEndTs = 0;
    let timerUIInterval = null;

    const scoreEl = document.getElementById('score');
    const timerEl = document.getElementById('timer');
    const startOverlay = document.getElementById('startOverlay');
    const finalOverlay = document.getElementById('finalOverlay');
    const startBtn = document.getElementById('startBtn');
    const soundBtn = document.getElementById('soundBtn');
    const playAgainBtn = document.getElementById('playAgain');
    const backToStartBtn = document.getElementById('backToStart');
    const bigAnimalChk = document.getElementById('bigAnimal');

    const ANIMALS = ["üê∂","üê±","üêπ","üê∞","ü¶ä","üêª","üêº","üê®","üê∑","üêµ","üê∏","üê•","ü¶Ñ"];
    const BIG_ANIMALS = ["ü¶Å","üêò","ü¶í","üê≥","ü¶à","ü¶ì"];
    const COLORS = [
      "rgba(255,255,255,.85)","rgba(255,245,210,.9)",
      "rgba(225,255,225,.9)","rgba(225,240,255,.9)"
    ];

    // –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –ø–æ —Ç—Ä—É–¥–Ω–æ—Å—Ç (–±–∞–∑–æ–≤–∏)
    const LEVELS = {
      easy:   { interval: 1100, speedMin: 5.5, speedMax: 8.0, perTick: () => 1 },
      medium: { interval: 850,  speedMin: 4.5, speedMax: 7.0, perTick: () => (Math.random()<0.6?2:1) },
      hard:   { interval: 650,  speedMin: 3.5, speedMax: 5.5, perTick: () => (Math.random()<0.5?2:3) }
    };

    function getSelected(name) {
      const el = document.querySelector(`input[name="${name}"]:checked`);
      return el ? el.value : null;
    }

    // ------- –ó–í–£–ö (WebAudio) -------
    function ensureAudio() {
      if (!audioCtx) {
        try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        catch { audioCtx = null; }
      }
    }
    function playPop(mult = 1) {
      if (!soundOn) return;
      ensureAudio();
      if (!audioCtx) return;

      const now = audioCtx.currentTime;

      // –¢–æ–Ω
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(mult > 1 ? 620 : 820, now);
      gain.gain.setValueAtTime(0.00001, now);
      gain.gain.exponentialRampToValueAtTime(0.25 * Math.min(mult,1.6), now + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.00001, now + 0.11);
      osc.connect(gain).connect(audioCtx.destination);
      osc.start(now);
      osc.stop(now + 0.12);

      // Noise —â–∏–ø–∫–∞
      const bufferSize = 256;
      const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const data = noiseBuffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) data[i] = (Math.random()*2-1)*(1 - i/bufferSize);
      const noise = audioCtx.createBufferSource();
      noise.buffer = noiseBuffer;
      const nGain = audioCtx.createGain();
      nGain.gain.setValueAtTime(0.00001, now);
      nGain.gain.exponentialRampToValueAtTime(0.18 * Math.min(mult,1.6), now + 0.005);
      nGain.gain.exponentialRampToValueAtTime(0.00001, now + 0.08);
      noise.connect(nGain).connect(audioCtx.destination);
      noise.start(now);
      noise.stop(now + 0.09);
    }

    soundBtn.addEventListener('click', () => {
      soundOn = !soundOn;
      soundBtn.setAttribute('aria-pressed', soundOn ? 'true' : 'false');
      soundBtn.textContent = soundOn ? 'üîä –ó–≤—É–∫: –í–∫–ª.' : 'üîà –ó–≤—É–∫: –ò–∑–∫–ª.';
      ensureAudio();
      if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
      if (soundOn) playPop();
    }, { passive: true });

    // ------- –ò–ì–†–ê -------
    function rand(min, max) { return Math.random() * (max - min) + min; }

    function makeAnimal(isBig, cfg) {
      const d = document.createElement('div');
      d.className = isBig ? 'animal big' : 'animal';
      d.style.left = `${rand(0, Math.max(0, window.innerWidth - (isBig?140:100)))}px`;
      d.style.background = COLORS[Math.floor(Math.random() * COLORS.length)];

      const dur = rand(cfg.speedMin, cfg.speedMax).toFixed(2);
      d.style.animationDuration = `${dur}s`;

      const span = document.createElement('span');
      span.className = 'emoji';
      span.textContent = isBig
        ? BIG_ANIMALS[Math.floor(Math.random()*BIG_ANIMALS.length)]
        : ANIMALS[Math.floor(Math.random()*ANIMALS.length)];
      d.appendChild(span);

      d.animate(
        [{transform:"translateY(105vh) scale(.9)"},{transform:"translateY(105vh) scale(1)"}],
        {duration:250, easing:"ease-out"}
      );

      d.addEventListener('pointerdown', (ev) => {
        catchAnimal(ev, d, isBig ? 5 : 1);
      }, { passive: true });

      document.body.appendChild(d);

      const ttl = parseFloat(dur) * 1000 + 220;
      setTimeout(() => d.remove(), ttl);
    }

    function popFx(x, y, text) {
      const fx = document.createElement('div');
      fx.className = 'pop';
      fx.textContent = text;
      fx.style.left = x + "px";
      fx.style.top  = y + "px";
      document.body.appendChild(fx);
      setTimeout(() => fx.remove(), 800);
    }

    function catchAnimal(ev, elem, points) {
      if (!elem.isConnected) return;
      score += points;
      scoreEl.textContent = "–¢–æ—á–∫–∏: " + score;
      playPop(points > 1 ? 1.4 : 1);

      const rect = elem.getBoundingClientRect();
      const x = ev.clientX || (rect.left + rect.width/2);
      const y = ev.clientY || (rect.top + rect.height/2);
      popFx(x, y, (points>1?`+${points}`:"+1"));

      elem.remove();

      // –í –±–µ–∑–∫—Ä–∞–µ–Ω —Ä–µ–∂–∏–º ‚Äì –¥–∏–Ω–∞–º–∏—á–Ω–æ –ø–æ–≤–∏—à–∞–≤–∞–Ω–µ –Ω–∞ —Ç—Ä—É–¥–Ω–æ—Å—Ç—Ç–∞
      if (mode === 'endless') maybeAdjustDifficulty();
    }

    function selectedLevelCfg() {
      return {...LEVELS[levelKey]}; // –∫–æ–ø–∏–µ
    }

    // –î–∏–Ω–∞–º–∏—á–µ–Ω —ä–ø—Å–∫–µ–π–ª –Ω–∞ —Ç—Ä—É–¥–Ω–æ—Å—Ç—Ç–∞ –≤ –±–µ–∑–∫—Ä–∞–µ–Ω —Ä–µ–∂–∏–º
    let curInterval = null;
    let curCfg = null;

    function maybeAdjustDifficulty() {
      const steps = Math.floor(score / 20); // –Ω–∞ –≤—Å–µ–∫–∏ 20 —Ç.
      const base = LEVELS[levelKey];
      const minInterval = 420; // –¥–æ–ª–Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞
      const speedBoost = Math.min(steps * 0.3, 1.6);
      const newCfg = {
        interval: Math.max(base.interval - steps * 80, minInterval),
        speedMin: Math.max(base.speedMin - speedBoost, 2.6),
        speedMax: Math.max(base.speedMax - speedBoost, base.speedMin), // –Ω–µ –ø–æ–¥ –º–∏–Ω–∏–º–∞–ª–Ω–æ—Ç–æ
        perTick: base.perTick // –æ—Å—Ç–∞–≤—è–º–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏—Ç–µ –æ—Ç –±–∞–∑–æ–≤–æ—Ç–æ –Ω–∏–≤–æ
      };
      curCfg = newCfg;

      // –∞–∫–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ä—Ç —Å–µ –µ –ø—Ä–æ–º–µ–Ω–∏–ª –æ—Å–µ–∑–∞–µ–º–æ ‚Äì —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–π spawn —Ç–∞–π–º–µ—Ä–∞
      if (curInterval !== newCfg.interval && spawnTimer) {
        clearInterval(spawnTimer);
        curInterval = newCfg.interval;
        spawnTimer = setInterval(() => tick(newCfg), newCfg.interval);
      }
    }

    function tick(cfg) {
      const n = cfg.perTick();
      for (let i = 0; i < n; i++) makeAnimal(false, cfg);
    }

    function startBigAnimalLoop(enabled) {
      if (bigTimer) { clearInterval(bigTimer); bigTimer = null; }
      if (!enabled) return;
      // –ø—ä—Ä–≤–∏ ‚Äû–±–æ—Å‚Äú —Å–ª–µ–¥ 6‚Äì12 —Å–µ–∫, –ø–æ—Å–ª–µ ~10 —Å–µ–∫
      const spawnBoss = () => makeAnimal(true, curCfg || selectedLevelCfg());
      setTimeout(spawnBoss, rand(6000, 12000));
      bigTimer = setInterval(spawnBoss, 10000);
    }

    function clearAllAnimals() {
      document.querySelectorAll('.animal').forEach(n => n.remove());
    }

    function startGame() {
      // –ø—Ä–æ—á–∏—Ç –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ
      levelKey = getSelected('level') || 'easy';
      mode = getSelected('mode') || 'timed';
      const bigEnabled = bigAnimalChk.checked;

      ensureAudio();
      if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();

      // UI
      startOverlay.style.display = 'none';
      finalOverlay.hidden = true;
      timerEl.hidden = (mode !== 'timed');
      score = 0;
      scoreEl.textContent = "–¢–æ—á–∫–∏: 0";

      // –Ω–∞—á–∞–ª–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
      curCfg = selectedLevelCfg();
      curInterval = curCfg.interval;

      // spawn loop
      tick(curCfg);
      if (spawnTimer) clearInterval(spawnTimer);
      spawnTimer = setInterval(() => tick(curCfg), curCfg.interval);

      // big animal –æ–ø—Ü–∏—è
      startBigAnimalLoop(bigEnabled);

      // —Ä–µ–∂–∏–º
      if (mode === 'timed') {
        startTimedRound(30); // 30 —Å–µ–∫—É–Ω–¥–∏
      } else {
        // –±–µ–∑–∫—Ä–∞–µ–Ω ‚Äì –Ω—É–ª–∏—Ä–∞–π –µ–≤–µ–Ω—Ç—É–∞–ª–µ–Ω —Ç–∞–∏–º–µ—Ä –æ—Ç –ø—Ä–µ–¥–∏—à–Ω–∞ –∏–≥—Ä–∞
        if (timerUIInterval) { clearInterval(timerUIInterval); timerUIInterval = null; }
      }

      // –¥–µ–ª–µ–≥–∏—Ä–∞–Ω–µ –∑–∞ –∫–ª–∏–∫ –ø–æ –µ–º–æ–¥–∂–∏
      document.addEventListener('pointerdown', docPointer, { passive: true });
    }

    function docPointer(ev) {
      const target = ev.target.closest?.('.animal');
      if (target) catchAnimal(ev, target, target.classList.contains('big') ? 5 : 1);
    }

    function endGame() {
      // —Å—Ç–æ–ø —Ç–∞–π–º–µ—Ä–∏ / –ø–æ—á–∏—Å—Ç–≤–∞–Ω–µ
      if (spawnTimer) { clearInterval(spawnTimer); spawnTimer = null; }
      if (bigTimer) { clearInterval(bigTimer); bigTimer = null; }
      if (timerUIInterval) { clearInterval(timerUIInterval); timerUIInterval = null; }
      document.removeEventListener('pointerdown', docPointer);
      clearAllAnimals();
    }

    function startTimedRound(seconds) {
      const startTs = performance.now();
      roundEndTs = startTs + seconds * 1000;

      // UI —Ç–∞–π–º–µ—Ä –ø—Ä–µ–∑ 100 ms
      const fmt = (msLeft) => (msLeft/1000).toFixed(1) + "s";
      timerEl.textContent = "‚è± " + fmt(seconds*1000);
      timerUIInterval = setInterval(() => {
        const now = performance.now();
        const left = Math.max(0, roundEndTs - now);
        timerEl.textContent = "‚è± " + fmt(left);
        if (left <= 0) {
          clearInterval(timerUIInterval);
          timerUIInterval = null;
          // –∫—Ä–∞–π –Ω–∞ —Ä—É–Ω–¥–∞
          endGame();
          // —Ñ–∏–Ω–∞–ª–µ–Ω –µ–∫—Ä–∞–Ω
          document.getElementById('finalScore').textContent = "–¢–æ—á–∫–∏: " + score;
          finalOverlay.hidden = false;
        }
      }, 100);
    }

    // –ö–æ–Ω—Ç—Ä–æ–ª–∏
    startBtn.addEventListener('click', startGame, { passive: true });
    playAgainBtn.addEventListener('click', () => {
      finalOverlay.hidden = true;
      // —Å—Ç–∞—Ä—Ç–∏—Ä–∞–º–µ —Å—ä—Å —Å—ä—â–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–ø—Ä–æ—á–∏—Ç–∞–º–µ –æ—Ç —Ñ–æ—Ä–º–∞—Ç–∞)
      startGame();
    }, { passive: true });
    backToStartBtn.addEventListener('click', () => {
      finalOverlay.hidden = true;
      startOverlay.style.display = 'grid'; // –≤—Ä—ä—â–∞–º–µ –∫—ä–º –∏–∑–±–æ—Ä–∞
    }, { passive: true });

    // –ó–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç –∞–∫–æ —Å–º–µ–Ω—è—à —Ä–∞–∑–º–µ—Ä–∞ –Ω–∞ –ø—Ä–æ–∑–æ—Ä–µ—Ü–∞
    window.addEventListener('resize', () => {}, { passive: true });
  </script>
</body>
</html>
